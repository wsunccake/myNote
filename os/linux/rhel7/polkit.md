# polkit

## service

```bash
centos:~ # yum install polkit

centos:~ # systemctl enable polkit.service
centos:~ # systemctl start polkit.service
centos:~ # systemctl status polkit.service
```

---

## config

```bash
# action
centos:~ # ls /usr/share/polkit-1/actions

# authorization rule (javascript syntax)
centos:~ # ls /etc/polkit-1/rules.d
centos:~ # ls /usr/share/polkit-1/rules.d
```

### rule - admin

```bash
centos:~ # cat /etc/polkit-1/rules.d/49-polkit-pkla-compat.rules
polkit.addAdminRule(function(action, subject) {
	var res = polkit.spawn(['/usr/bin/pkla-admin-identities']);
	//polkit.log('Got "' + res.replace(/\n/g, '\\n') + '"\n');
	if (res == '')
		return null;
	var identities = res.split('\n');
	//polkit.log('Identities: ' + identities.join(',') + '\n');
	if (identities[identities.length - 1] == '')
		identities.pop()
	//polkit.log('Returning: ' + identities.join(',') + '\n');
	return identities;
});
...

centos:~ # cat /etc/polkit-1/rules.d/50-default.rules
/* -*- mode: js; js-indent-level: 4; indent-tabs-mode: nil -*- */

// DO NOT EDIT THIS FILE, it will be overwritten on update
//
// Default rules for polkit
//
// See the polkit(8) man page for more information
// about configuring polkit.

polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
```

---

## example

### debugging / logging

```bash
centos:~ # cat /etc/polkit-1/rules.d/00-log-access.rules
polkit.addRule(function(action, subject) {
    polkit.log("action=" + action);
    polkit.log("subject=" + subject);
});
```

### disable suspend and hibernate

```bash
centos:~ # cat /etc/polkit-1/rules.d/10-disable-suspend.rules
polkit.addRule(function(action, subject) {
    if (action.id == "org.freedesktop.login1.suspend" ||
        action.id == "org.freedesktop.login1.suspend-multiple-sessions" ||
        action.id == "org.freedesktop.login1.hibernate" ||
        action.id == "org.freedesktop.login1.hibernate-multiple-sessions")
    {
        return polkit.Result.NO;
    }
});
```

### bypass password prompt

```bash
# globally
centos:~ # /etc/polkit-1/rules.d/49-nopasswd_global.rules
/* Allow members of the wheel group to execute the defined actions
 * without password authentication, similar to "sudo NOPASSWD:"
 */
polkit.addRule(function(action, subject) {
    if ((action.id == "org.gnome.gparted" ||
	 action.id == "org.libvirt.unix.manage") &&
        subject.isInGroup("wheel"))
    {
        return polkit.Result.YES;
    }
});

# for specific actions
centos:~ # cat /etc/polkit-1/rules.d/49-nopasswd_limited.rules
/* Allow members of the wheel group to execute the defined actions
 * without password authentication, similar to "sudo NOPASSWD:"
 */
polkit.addRule(function(action, subject) {
    if ((action.id == "org.gnome.gparted" ||
	 action.id == "org.libvirt.unix.manage") &&
        subject.isInGroup("wheel"))
    {
        return polkit.Result.YES;
    }
});
```

### allow management of individual systemd units by regular user

```bash
centos:~ # cat /etc/polkit-1/rules.d/10-wifimanagement.rules
polkit.addRule(function(action, subject) {
    if (action.id == "org.freedesktop.systemd1.manage-units") {
        if (action.lookup("unit") == "wpa_supplicant.service") {
            var verb = action.lookup("verb");
            if (verb == "start" || verb == "stop" || verb == "restart") {
                return polkit.Result.YES;
            }
        }
    }
});
```
